// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザーテーブル
model User {
  id            String    @id @default(uuid())
  oauthProvider String    // "google" or "line"
  oauthId       String    @unique
  email         String?
  displayName   String?
  walletAddress String?   // 後でAA実装時に使用
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // リレーション
  userStamps    UserStamp[]
  compositeNfts CompositeNft[]
  
  @@unique([oauthProvider, oauthId])
  @@map("users")
}

// スタンプマスターテーブル
model Stamp {
  id          String   @id @default(uuid())
  type        String   // "background" or "character"
  name        String
  imageUrl    String
  qrCode      String   @unique // QRコードに埋め込まれる一意の文字列
  description String?
  createdAt   DateTime @default(now())
  
  // リレーション
  userStamps        UserStamp[]
  compositeBackgrounds CompositeNft[] @relation("BackgroundStamp")
  compositeCharacters  CompositeNft[] @relation("CharacterStamp")
  
  @@map("stamps")
}

// ユーザーが獲得したスタンプ
model UserStamp {
  id         String   @id @default(uuid())
  userId     String
  stampId    String
  acquiredAt DateTime @default(now())
  
  // リレーション
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  stamp Stamp @relation(fields: [stampId], references: [id], onDelete: Cascade)
  
  @@unique([userId, stampId]) // 同じスタンプは1回しか獲得できない
  @@map("user_stamps")
}

// 合成されたNFT
model CompositeNft {
  id                  String   @id @default(uuid())
  userId              String
  backgroundStampId   String
  characterStampId    String
  compositeImageUrl   String
  nftTokenId          String?  // ブロックチェーン実装後に使用
  nftTxHash           String?  // トランザクションハッシュ
  createdAt           DateTime @default(now())
  
  // リレーション
  user             User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  backgroundStamp  Stamp @relation("BackgroundStamp", fields: [backgroundStampId], references: [id])
  characterStamp   Stamp @relation("CharacterStamp", fields: [characterStampId], references: [id])
  
  @@map("composite_nfts")
}